# 个人开发日志-lihan3238

---

## 24.7.8: 开发环境搭建

### 日志

#### 安装 `kali-linux-2024.2-virtualbox-amd64` 虚拟机

1. 下载虚拟硬盘文件 `.vdi`

[官网下载](https://cdimage.kali.org/kali-2024.2/kali-linux-2024.2-virtualbox-amd64.7z) 最新版 `kali-linux-2024.2-virtualbox-amd64`

2. 在 `VirtualBox` 中创建虚拟机

新建虚拟机，选择 `Using an existing virtual hard disk file`，选择下载的 `kali-linux-2024.2-virtualbox-amd64.vdi` 文件。

![muti_vdi](../img/lihan3238_doc/muti_vdi.png)

创建虚拟机后，设置虚拟硬盘文件为 `多重加载` 以便于重复使用。
虚拟机其他配置信息如下：

![kali_info](../img/lihan3238_doc/kali_info.png)

3. 配置虚拟机网络

在 VirtualBox 中，创建一个 `Host-Only` 网络，设置 IPv4 网段为 `192.168.78.0/24`，启用 DHCP 服务器。

在创建好的虚拟机中，设置添加一个 `Host-Only` 网卡，选择刚刚创建的 `Host-Only` 网络，一共是两个网卡，一个是 `NAT`，一个是 `Host-Only`。

启动虚拟机后，配置 `Host-Only` 网卡 `eth1` ，编辑 `/etc/network/interfaces` 文件，添加如下配置：

```bash
auto lo
iface lo inet loopback

allow-hotplug eth0
iface eth0 inet dhcp

allow-hotplug eth1
iface eth1 inet dhcp
```
重启网络服务，使配置生效：
```bash
sudo ifdown eth1 && sudo ifup eth1
```

**严重问题** VirtualBox DHCP 服务器异常，虚拟机无法获取到 IP 地址，导致无法访问网络。

![wrong_1](../img/lihan3238_doc/wrong_1.png)

![wrong_2](../img/lihan3238_doc/wrong_2.png)

暂无解决方案，不得已转进 Vmware重新配置环境，顺便配置了 SSH 免密登录

虚拟机配置如下：

- hostname: `kalitargetserver`
- - user: `kali`
- - eth0: NAT
- - - ip: `192.168.4.129`
- - eth1: Host-Only
- - - ip: `192.168.102.129`
- host: `kaliattacker`
- - user: `kali`
- - eth0: NAT
- - - ip: `192.168.4.130`
- - eth1: Host-Only
- - - ip: `192.168.102.130`

#### 安装 Docker

```bash
sudo apt update && sudo apt install -y docker.io docker-compose jq

# 将当前用户添加到 docker 用户组，免 sudo 执行 docker 相关指令
# 重新登录 shell 生效
sudo usermod -a -G docker ${USER}

# 切换到 root 用户
sudo su -

# 使用国内 Docker Hub 镜像源（可选步骤）
# 国内 Docker Hub 镜像源可用性随时可能变化，请自测可用性
cat <<EOF > /etc/docker/daemon.json
{
  "registry-mirrors": [
    "https://docker.mirrors.sjtug.sjtu.edu.cn/",
    "https://mirror.baidubce.com/",
    "https://dockerproxy.com/",
    "https://docker.chenby.cn"
  ]
}
EOF

# 重启 docker 守护进程
systemctl restart docker
```

### 问题

#### 1. Kali 虚拟机无法正常启动

![error_1](../img/lihan3238_doc/error_1.png)

- 原因：安装了 Docker，Docker 开发环境会强制开启 Hyper-V ，导致 VirtualBox 无法启动。

- 解决：打开 `开始` 菜单，搜索 `程序和功能`,选择 `启用或关闭 Windows 功能`，在列表中找到 `Hyper-V` 把前面的勾选取消并确定。这个时候已经开始卸载，卸载完毕重启电脑即可。

![soluting_1](../img/lihan3238_doc/soluting_1.png)

![soluted_1](../img/lihan3238_doc/soluted_1.png)

如果还是不行那就用命令行再进行关闭。
以管理员身份运行命令提示符
执行命令
```bash
bcdedit /set hypervisorlaunchtype off
```
重启，运行 Virtual Box 即可

**恢复hyper启动**
```bash
bcdedit / set hypervisorlaunchtype auto
```

**一劳永逸**
Windows 上安装 Docker 时，选择 `WSL2 instead of HyperV`，装在 WSL2 上就完了

#### 2. 虚拟硬盘多重加载失败

![error_2](../img/lihan3238_doc/error_2.png)

- 原因：`.vdi` 文件版本格式问题，猜测解决方案是启动虚拟机后，VirtualBox会自动更新虚拟硬盘文件的版本，从而解决了版本的问题。

- 解决：先使用该虚拟硬盘创建虚拟机，打开虚拟机，然后关闭虚拟机，再设置多重加载该虚拟硬盘文件。

![soluted_2](../img/lihan3238_doc/soluted_2.png)

#### 3. 无法使用 SSH 连接虚拟机

- 原因：`/etc/ssh/sshd_config` 文件中，服务配置被注释：
```bash
Include /etc/ssh/sshd_config.d/*.conf

#Port 22
#AddressFamily any
#ListenAddress 0.0.0.0
#ListenAddress ::
```

- 解决：取消注释，`sudo systemctl restart sshd` 重启服务，`sudo systemctl enable ssh&&sudo systemctl start ssh` 

### 参考

- [Docker和Virtualbox的冲突](https://lihan3238.github.io/p/point_1/)
- [配置虚拟机与虚拟硬盘](https://lihan3238.github.io/p/nschap0x01/#%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%8E%E8%99%9A%E6%8B%9F%E7%A1%AC%E7%9B%98)
- [ChatGPT](https://chatgpt.com/)

---
